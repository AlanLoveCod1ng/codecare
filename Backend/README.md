# Setup & Installation:

        pip install -r requirements.txt

# How to run:

Under [codecare/Backend](./) folder, run

        python3 run.py

# API Guide

## /login
It's a get/post method, must be called by a HTML form with method of post and a input text with ```id = "email"``` and a input password with ```id = "password"``` e.g.

    <form action="http://127.0.0.1:5000/login" method="post">
        <label for="email">email</label><input type="text" name="email" id="email">
        <label for="password">password</label><input type="password" name="password" id="password">
        <input type="submit">
    </form>
login will verify the email and password, generate token and redirect to ```/account```
### Message
<ul>
    <li>If form doesn't have email and password, will return message of "Error with form" and response 401.</li>
    <li>If email and password can't be verify will return message of "Could not verify!" with response 401.</li>
</ul>

## /register
Similar to [/account](#account), get method and ```"first_name"```, ```"second_name"```, ```"email"```, ```"password"```, ```"phone"```,  ```"state"``` in the url are required, state should be full name of state, no lowercase uppercase requirement.<br>
We only allow patient creating account so /register will only create patient account.
### Message
<ul>
    <li>If form miss input, message "Error with form," and response code 401 are returned.</li>
    <li>If error with database operation, message "Can't register" and response 401 are returned.</li>
    <li>If error with database operation, message "Can't register" and response 401 are returned.</li>
    <li>If account already exist, message "User already exists. Please Log in." and code 202 will be returned</li>
    <li>If register successfully, message "Successfully registered." and code 201 will be returned.</li>
</ul>

## Token Required
All the API call except login and register is token required. Token required means token must be passed as a parameter to API in he url. See example in the [/account](#account).<br>
Every token is generated by [/login](#/login), each token will be expired after 30 minutes, login is required once token is expired.
### Message
<ul>
    <li>If token is not included, message "Token is missing!" is returned.</li>
    <li>If token is not valid, message "Token is invalid" and response 403 is returned.</li>
</ul>

## /account

Redirect from /login, account will return a json file which contains all the information of account. Token will be included, store it because it it's required in the future API call. <br>
/account example:

        http://127.0.0.1:5000/account&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxMSwiZXhwIjoxNjY5MjUzNzM0fQ.2YHjBmt4iEUoPb48tbLfdhel6h7I3bgjdX8saVsNrOA

returned json example
```json
{
  "account_id": 11,
  "email": "vehicula.aliquet.libero@icloud.ca",
  "first_name": "Giacomo",
  "id": 11,
  "is_patient": 0,
  "last_name": "Wall",
  "password": "3791",
  "phone": "1-284-622-9244",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxMSwiZXhwIjoxNjY5MjUzNzM0fQ.2YHjBmt4iEUoPb48tbLfdhel6h7I3bgjdX8saVsNrOA"
}
```
### Message
No error message will be returned from /account, only possible error is in [Token Required](#token-required).


## /patients
Token required

This API is for provider only, it will return information about all patients belong to current provider.

## /provider
Token required

This API is for patient only, it will return information about his/her provider's information so that patient could contact their provider.

## /notification
Token required.

This API call will return list of notifications of this patient or provider in json format, except token is required as argument in url, two other types arguments are allowed to customize.

```filter```, filter accept two different parameters, ```waiting``` and ```processed```, by calling ```filter=waiting```, API will only return the notification which are waiting to be processed, ```filter=processed``` will only return the notifications that have already been processed.


```first``` will return the first few notifications after filtering. ```first=10``` will return top 10 notifications of query result.

API call example:

        /notification?filter=waiting&first=2&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxMSwiZXhwIjoxNjY5MjUzNzM0fQ.2YHjBmt4iEUoPb48tbLfdhel6h7I3bgjdX8saVsNrOA

Here is the returned json for above API call:
```json
[
  {
    "account_id": 11,
    "city": "San Jose",
    "content": "cursus non, egestas a, dui. Cras pellentesque. Sed dictum. Proin eget odio. Aliquam vulputate ullamcorper magna. Sed eu eros. Nam consequat dolor vitae dolor. Donec fringilla. Donec feugiat metus sit amet ante. Vivamus non lorem vitae odio sagittis semper. Nam tempor diam dictum sapien. Aenean massa. Integer vitae nibh. Donec est mauris, rhoncus id, mollis nec, cursus a, enim. Suspendisse aliquet, sem ut cursus luctus, ipsum leo elementum sem, vitae aliquam eros turpis non enim. Mauris quis turpis vitae purus gravida sagittis. Duis gravida. Praesent eu nulla at sem molestie sodales. Mauris blandit enim consequat purus. Maecenas libero est, congue a, aliquet vel, vulputate eu, odio. Phasellus at augue id ante dictum cursus. Nunc mauris elit, dictum eu, eleifend nec, malesuada ut, sem. Nulla interdum. Curabitur dictum. Phasellus in felis. Nulla tempor augue ac ipsum. Phasellus vitae mauris sit amet lorem semper auctor. Mauris vel turpis. Aliquam adipiscing lobortis risus. In mi pede, nonummy ut, molestie in, tempus eu, ligula. Aenean euismod mauris eu elit. Nulla facilisi. Sed neque. Sed eget lacus. Mauris non dui nec urna suscipit nonummy. Fusce fermentum fermentum arcu. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae Phasellus ornare. Fusce mollis. Duis sit amet diam eu dolor egestas rhoncus. Proin nisl sem, consequat nec, mollis vitae, posuere at, velit. Cras lorem lorem, luctus ut, pellentesque eget, dictum placerat, augue. Sed molestie. Sed id risus",
    "datetime": "10/28/2018, 00:07:15",
    "notificaiont_id": 1,
    "state": "California",
    "processed": 0
  },
  {
    "account_id": 11,
    "city": "Sacramento",
    "content": "in lobortis tellus justo sit amet nulla. Donec non justo. Proin non massa non ante bibendum ullamcorper. Duis cursus, diam at pretium aliquet, metus urna convallis erat, eget tincidunt dui augue eu tellus. Phasellus elit pede, malesuada vel, venenatis vel, faucibus id, libero. Donec consectetuer mauris id sapien. Cras dolor dolor, tempus non, lacinia at, iaculis quis, pede. Praesent eu dui. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Aenean eget magna. Suspendisse tristique neque venenatis lacus. Etiam bibendum fermentum metus. Aenean sed pede nec ante blandit viverra. Donec tempus, lorem fringilla ornare placerat, orci lacus vestibulum lorem, sit amet ultricies sem magna nec quam. Curabitur vel lectus. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec dignissim magna a tortor. Nunc commodo auctor velit. Aliquam nisl. Nulla eu",
    "datetime": "07/01/2021, 00:43:38",
    "notificaiont_id": 2,
    "state": "California",
    "processed": 0
  }
]
```

This one will return first 10 notifications which are waiting to be processed.

UPDATE: Now returned notifications will be ordered by datetime, descending order (most recent on the top).

TODO: This one only supports provider version, patient one is still under development.

## /record/<patient_id>
Token required

Note that in order to allow both patient and provider could access patient's location records, the patient identification will not be passed through token, rather than route.

There are two sources of patient_id, if current login user is patient, patient_id already returned when login, if current login user is provider, then he can get patient_id via calling [/patients](#patient).

This API is for both patient and provider which will return patient's locations record in json file. /record has one extra allowed argument.

```first``` same as [/notification](#notification).

UPDATE: Now returned record will also be ordered by datetime, descending order (most recent on the top).

### Message
<ul>
    <li>If Patient id doesn't exist, message "Invalid Patient ID" and code 401 will be returned.</li>
</ul>

## /send/<notification_id>
Token required

This API is for provider only. When call this API, a notification will be sent from provider to all his patient.

For example,

    http://127.0.0.1:5000/send/458?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxMSwiZXhwIjoxNjY5NTk4ODMyfQ.B1ls3cpK1FpdMVoSDcpg_1IYSdOHns1lBs4iwtrixnw

will send notification with ```id=458``` from provider represented by this token to all patients belong to this provider.

The id of notification ```notification_id``` is passed to frontend in the response of [/notification](#notification).

After this, the notification will be marked as processed for this provider.

### Message
<ul>
    <li>If given token is for Patient, message "Provider Only." and code 403 will be returned</li>
    <li>If this notificaion is already been processed before, message "Notification alreay processed" and code 202 will be returned</li>
    <li>If something wrong with inserting record to database, message "Error with inserting record" and code 401 will be returned.</li>
    <li>If send notification successfully, message "Notification sent to %d patient" and code 201 will be returned, %d is the number of patients receiving this notification.</li>
</ul>


## /deny/<notification_id>
Token required

This API is for provider only. When call this API, a notification will be denied and marked as processed.

For example,

    http://127.0.0.1:5000/deny/458?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxMSwiZXhwIjoxNjY5NTk4ODMyfQ.B1ls3cpK1FpdMVoSDcpg_1IYSdOHns1lBs4iwtrixnw

will deny notification with ```id=458``` without sending to patients


After this, the notification will be marked as processed for this provider.

### Message
<ul>
    <li>If given token is for Patient, message "Provider Only." and code 403 will be returned</li>
    <li>If this notificaion is already been processed before, message "Notification alreay processed" and code 202 will be returned</li>
    <li>If something wrong with applying changes to database, message "Error with changing data" and code 401 will be returned.</li>
    <li>If send notification successfully, message "Notification denied" and code 201 will be returned.</li>
</ul>

## /read/<notification_id>
Token required

This API is for patient only. When call this API, a notification will be marked as read.

For example,

    http://127.0.0.1:5000/read/458?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50X2lkIjoxLCJleHAiOjE2NzAwMDY4MDh9.5WHQNw5Q1zGnqARrv459emsZRhvjvH0YGEC1rVWMmGQ

will mark notification with ```id=458``` for this patient


After this, the notification will be marked as processed for this provider.

### Message
<ul>
    <li>If given token is for Provider, message "Patient Only." and code 403 will be returned</li>
    <li>If this notificaion is already been read before, message "Notification alreay read" and code 202 will be returned</li>
    <liß>If something wrong with applying changes to database, message "Error with changing data" and code 401 will be returned.</liß>
    <li>If send notification successfully, message "Notification read" and code 201 will be returned.</li>
</ul>

## /new_record
Token required

This API call is patient only. This API call will create a new location record for patient specified by token, and it will pass three required args.

```lat=43.0722``` latitude of current location.

```lon=-89.4008``` longitue of current location.

```datetime=2022-11-28+21:08:46``` datetime when location data get fetched.

Note that datetime format should be ```%Y-%m-%d %H:%M:%S``` since that url doesn't allow space, just replace it with plus sign ```+```.

### Message
<ul>
    <li>If given token is for provider, message "Patient Only." and code 403 will be returned</li>
    <li>If one of above args missing, message "Missing args" and code 403 returned</li>
    <li>If datetime format wrong, message "Invalid datetime format" and code 401 returned.</li>
    <li>If current location is not in the US, message "Not in US." and code 401 returned</li>
    <li>If error with inserting into database, message "Error inserting data." and code 403 returned</li>
    <li>If insert successfully, message "Successfully add record." and code 202 returned</li>
</ul>